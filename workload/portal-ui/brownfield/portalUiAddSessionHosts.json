{
    "$schema": "<relative path to createFormUI.schema.json>",
    "view": {
        "kind": "Form",
        "properties": {
            "isWizard": false,
            "title": "Azure Virtual Desktop LZA: Deploy New Session Hosts",
            "steps": [
                {
                    "name": "basics",
                    "label": "Deployment Basics",
                    "elements": [
                        {
                            "name": "resourceScope",
                            "type": "Microsoft.Common.ResourceScope",
                            "location": {
                                "resourceTypes": [
                                    "Microsoft.Compute/virtualMachines"
                                ]
                            }
                        },
                        {
                            "name": "resourceGroupsApi",
                            "type": "Microsoft.Solutions.ArmApiControl",
                            "request": {
                                "method": "GET",
                                "path": "[concat(steps('basics').resourceScope.subscription.id, '/resourceGroups?api-version=2021-04-01')]"
                            }
                        },
                        {
                            "name": "ComputeResourceGroup",
                            "type": "Microsoft.Common.DropDown",
                            "label": "Pool compute resource group",
                            "multiselect": false,
                            "defaultValue": "",
                            "toolTip": "Select the name of the existing resource group where the host pool compute resources will be deployed.",
                            "constraints": {
                                "allowedValues": "[map(steps('basics').resourceGroupsApi.value, (item) => parse(concat('{\"label\":\"', item.name, '\",\"value\":\"', item.name, '\"}')))]",
                                "required": true
                            },
                            "infoMessages": [],
                            "visible": true
                        },
                        {
                            "name": "infoResourceGroupNaming",
                            "type": "Microsoft.Common.TextBlock",
                            "visible": true,
                            "options": {
                                "text": "Azure Virtual Desktop Landing Zones will create the resource group hierarchy under the subscriptions with the prefix provided in this step.",
                                "link": {
                                    "label": "Learn more",
                                    "uri": "https://docs.microsoft.com/azure/cloud-adoption-framework/ready/enterprise-scale/management-group-and-subscription-organization"
                                }
                            }
                        },
                        {
                            "name": "deploymentSpecs",
                            "type": "Microsoft.Common.Section",
                            "visible": true,
                            "label": "Deployment Specs",
                            "elements": [
                                {
                                    "name": "deploymentPrefix",
                                    "type": "Microsoft.Common.TextBox",
                                    "label": "Prefix",
                                    "toolTip": "Provide a prefix (max 4 characters) for the resource groups and resources created as part of Azure Virtual Desktop landing zones.",
                                    "placeholder": "Example: app1",
                                    "constraints": {
                                        "required": true,
                                        "regex": "^[a-z0-9A-Z-]{1,4}$",
                                        "validationMessage": "The prefix must be 1-4 characters."
                                    }
                                },
                                {
                                    "name": "deploymentEnvironment",
                                    "type": "Microsoft.Common.DropDown",
                                    "visible": true,
                                    "label": "Environment",
                                    "defaultValue": "Development",
                                    "toolTip": "Select the type of environment (Development (d), Test (t), Production (p)) that will be deployed, this information will be use as part of the resources naming.",
                                    "constraints": {
                                        "allowedValues": [
                                            {
                                                "label": "Development",
                                                "value": "Dev"
                                            },
                                            {
                                                "label": "Test",
                                                "value": "Test"
                                            },
                                            {
                                                "label": "Production",
                                                "value": "Prod"
                                            }
                                        ]
                                    }
                                }
                            ]
                        }
                    ]
                },
                {
                    "name": "identity",
                    "label": "Identity",
                    "elements": [
                        {
                            "name": "identityInfo",
                            "type": "Microsoft.Common.InfoBox",
                            "visible": true,
                            "options": {
                                "text": "Azure Virtual Desktop LZA deployment expects identity service to be already available in the current Azure estate.",
                                "uri": "https://docs.microsoft.com/azure/virtual-desktop/authentication#identities",
                                "style": "Info"
                            }
                        },
                        {
                            "name": "identityDomainInformation",
                            "type": "Microsoft.Common.Section",
                            "visible": true,
                            "label": "Domain to join",
                            "elements": [
                                {
                                    "name": "identityServiceProvider",
                                    "type": "Microsoft.Common.OptionsGroup",
                                    "visible": true,
                                    "label": "Identity service provider",
                                    "defaultValue": "Active Directory (AD DS)",
                                    "toolTip": "Identity service provider (ADDS or AADDS) that already exist and will be used for Azure Virtual Desktop.",
                                    "constraints": {
                                        "required": true,
                                        "allowedValues": [
                                            {
                                                "label": "Microsoft Entra ID",
                                                "value": "AAD"
                                            },
                                            {
                                                "label": "Active Directory (AD DS)",
                                                "value": "ADDS"
                                            },
                                            {
                                                "label": "Microsoft Entra Domain Services",
                                                "value": "AADDS"
                                            }
                                        ]
                                    }
                                },
                                {
                                    "name": "identityServiceProviderIntuneEnrollment",
                                    "type": "Microsoft.Common.CheckBox",
                                    "visible": "[equals(steps('identity').identityDomainInformation.identityServiceProvider, 'AAD')]",
                                    "label": "Intune enrollment",
                                    "defaultValue": false,
                                    "toolTip": "If Intune is configured in your Microsoft Entra ID tenant, you can choose to have the VM automatically enrolled during the deployment by selecting this box."
                                },
                                {
                                    "name": "identityServiceProviderInfo",
                                    "type": "Microsoft.Common.InfoBox",
                                    "visible": "[not(equals(steps('identity').identityDomainInformation.identityServiceProvider, 'AAD'))]",
                                    "options": {
                                        "text": "Identity service provider must already exist, as they are a prerequisite for the Azure Virtual Desktop LZA deployment.",
                                        "uri": "https://github.com/Azure/avdaccelerator/blob/main/workload/docs/getting-started.md",
                                        "style": "Info"
                                    }
                                }
                            ]
                        },
                        {
                            "name": "identityAvdAccess",
                            "type": "Microsoft.Common.Section",
                            "visible": true,
                            "label": "Azure Virtual Desktop access assignment",
                            "elements": [
                                {
                                    "name": "groupsApi",
                                    "type": "Microsoft.Solutions.GraphApiControl",
                                    "request": {
                                        "method": "GET",
                                        "path": "/v1.0/groups?$top=999"
                                    }
                                },
                                {
                                    "name": "identityAvdUserAccessGroupDropDown",
                                    "type": "Microsoft.Common.DropDown",
                                    "visible": "[not(steps('identity').identityAvdAccess.identityAvdUserAccessGroupCheckBox)]",
                                    "label": "Groups",
                                    "defaultValue": "",
                                    "filter": true,
                                    "toolTip": "Select the desired group to give access to Azure Virtual Desktop resources and if applicable to FSLogix file share",
                                    "multiselect": false,
                                    "constraints": {
                                        "allowedValues": "[map(steps('identity').identityAvdAccess.groupsApi.value, (item) => parse(concat('{\"label\":\"', item.displayName, '\",\"value\": {\"name\":\"', item.displayName, '\",\"id\":\"', item.id, '\"}}')))]"
                                    }
                                },
                                {
                                    "name": "identityAvdUserAccessGroupCheckBox",
                                    "type": "Microsoft.Common.CheckBox",
                                    "visible": true,
                                    "label": "Provide group details",
                                    "defaultValue": false,
                                    "toolTip": "When the desired group is not listed in the drop down, selecting this box will allow for entering the group's ObjectID and name. this information will be used to setup AVD access and FSLogix's file share NTFS permissions."
                                },
                                {
                                    "name": "identityAvdUserAccessGroupTextBox1",
                                    "type": "Microsoft.Common.TextBox",
                                    "visible": "[steps('identity').identityAvdAccess.identityAvdUserAccessGroupCheckBox]",
                                    "label": "Name",
                                    "toolTip": "Group name to be granted access to Azure Virtual Desktop published items and FSLogix NTFS permissions.",
                                    "placeholder": "Example: AVD-users"
                                },
                                {
                                    "name": "identityAvdUserAccessGroupTextBox2",
                                    "type": "Microsoft.Common.TextBox",
                                    "visible": "[steps('identity').identityAvdAccess.identityAvdUserAccessGroupCheckBox]",
                                    "label": "Object ID",
                                    "toolTip": "Group objectID to be granted access to Azure Virtual Desktop published items and FSLogix NTFS permissions.",
                                    "placeholder": "Example: XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX"
                                }
                            ]
                        },
                        {
                            "name": "identityCredentials",
                            "type": "Microsoft.Common.Section",
                            "visible": true,
                            "label": "Credentials",
                            "elements": [
                                {
                                    "name": "secretsKeyvault",
                                    "type": "Microsoft.Solutions.ResourceSelector",
                                    "label": "Key vault",
                                    "toolTip": "Select the AVD LZA deployed keyvault that contains the local user and domain join credentials.",
                                    "resourceType": "Microsoft.KeyVault/vaults",
                                    "constraints": {
                                        "required": true
                                    },
                                    "options": {
                                        "filter": {
                                            "subscription": "onBasics"
                                        }
                                    }
                                },
                                {
                                    "name": "identityDomainJoinUserName",
                                    "type": "Microsoft.Common.TextBox",
                                    "visible": "[not(equals(steps('identity').identityDomainInformation.identityServiceProvider, 'AAD'))]",
                                    "label": "Domain join principal name",
                                    "placeholder": "Example: avdadmin@contoso.com",
                                    "defaultValue": "",
                                    "toolTip": "Provide username with permissions to join session host to the domain.",
                                    "constraints": {
                                        "required": true
                                    }
                                },
                                {
                                    "name": "identityDomainJoinUserPassword",
                                    "type": "Microsoft.Common.TextBox",
                                    "visible": "[not(equals(steps('identity').identityDomainInformation.identityServiceProvider, 'AAD'))]",
                                    "label": "Domain Join Password secret name",
                                    "toolTip": "Provide keyvault secret name for domain join password.",
                                    "defaultValue": "domainJoinUserPassword",
                                    "constraints": {
                                        "required": true
                                    }
                                },
                                {
                                    "name": "identityLocalUserName",
                                    "type": "Microsoft.Common.TextBox",
                                    "label": "VM local admin username",
                                    "toolTip": "Provide username for session host local admin account. Administrator can't be used as username, it is reserved by the system.",
                                    "placeholder": "Example: avdadmin",
                                    "defaultValue": "",
                                    "constraints": {
                                        "regex": "^(?!.*[aA]dministrator).*$",
                                        "validationMessage": "This username can't be used, it is a reserved word.",
                                        "required": true
                                    }
                                },
                                {
                                    "name": "identityLocalUserPassword",
                                    "type": "Microsoft.Common.TextBox",
                                    "label": "VM local admin password secret name",
                                    "toolTip": "Provide keyvault secret name for VM local admin password.",
                                    "defaultValue": "vmLocalUserPassword",
                                    "constraints": {
                                        "required": true
                                    }
                                }
                            ]
                        }
                    ]
                },
                {
                    "name": "managementPlane",
                    "label": "Management plane",
                    "elements": [
                        {
                            "name": "managementPlaneSettings",
                            "type": "Microsoft.Common.Section",
                            "label": "Settings:",
                            "elements": [
                                {
                                    "name": "fslogixStorageAccountSelector",
                                    "type": "Microsoft.Solutions.ResourceSelector",
                                    "label": "Host pool",
                                    "toolTip": "Select host pool where to add new session hosts.",
                                    "resourceType": "Microsoft.DesktopVirtualization/hostpools",
                                    "constraints": {
                                        "required": true
                                    },
                                    "options": {
                                        "filter": {
                                            "subscription": "onBasics"
                                        }
                                    }
                                }
                            ]
                        }
                    ]
                },
                {
                    "name": "sessionHosts",
                    "label": "Session hosts",
                    "elements": [
                        {
                            "name": "sessionHostsRegionSection",
                            "type": "Microsoft.Common.Section",
                            "visible": true,
                            "label": "Region Settings",
                            "tooltip": "The section allows you to specify the region where the compute, storage, and key vault resources are deployed.",
                            "elements": [
                                {
                                    "name": "computeApi",
                                    "type": "Microsoft.Solutions.ArmApiControl",
                                    "request": {
                                        "method": "GET",
                                        "path": "[concat(steps('basics').resourceScope.subscription.id,'/providers/Microsoft.Compute/resourceTypes?api-version=2021-04-01')]"
                                    }
                                },
                                {
                                    "name": "infoAvailZones",
                                    "type": "Microsoft.Common.InfoBox",
                                    "visible": true,
                                    "options": {
                                        "text": "If you select 'Use availability zones' below, some regions may not be available for deployment of session hosts because not all regions support Availability Zones. \n\nThe 'Session hosts region' drop down will automatically update based on this selection. If the value changes to blank, select an alternate region or set 'Use availability zones' to 'No'.",
                                        "uri": "https://learn.microsoft.com/azure/reliability/availability-zones-service-support#azure-regions-with-availability-zone-support",
                                        "style": "Info"
                                    }
                                },
                                {
                                    "name": "sessionHostsAvailabilityZoneSettings",
                                    "type": "Microsoft.Common.CheckBox",
                                    "visible": true,
                                    "label": "Availability zones",
                                    "defaultValue": true,
                                    "toolTip": "Distribute compute resources across availability zones."
                                },
                                {
                                    "name": "sessionHostsAvailabilitySetSettings",
                                    "type": "Microsoft.Common.CheckBox",
                                    "visible": "[not(steps('sessionHosts').sessionHostsRegionSection.sessionHostsAvailabilityZoneSettings)]",
                                    "label": "Availability set",
                                    "defaultValue": true,
                                    "toolTip": "Use availability sets to distribute session hosts across fault and update domains."
                                },
                                {
                                    "name": "sessionHostsAvailabilitySetResourceId",
                                    "type": "Microsoft.Solutions.ResourceSelector",
                                    "label": "Select availability set",
                                    "visible": "[and(steps('sessionHosts').sessionHostsRegionSection.sessionHostsAvailabilitySetSettings, not(steps('sessionHosts').sessionHostsRegionSection.sessionHostsAvailabilityZoneSettings))]",
                                    "resourceType": "Microsoft.Network/applicationSecurityGroups",
                                    "constraints": {
                                        "required": true
                                    },
                                    "options": {
                                        "filter": {
                                            "subscription": "onBasics",
                                            "location": "[steps('SessionHosts').SessionHostsRegionSection.SessionHostsRegion.location.name]"
                                        }
                                    }
                                },
                                {
                                    "name": "sessionHostsRegion",
                                    "type": "Microsoft.Common.DropDown",
                                    "label": "Session hosts region",
                                    "defaultValue": "[steps('basics').resourceScope.location.displayName]",
                                    "filter": true,
                                    "toolTip": "Select the region where the session hosts and required resources are to be deployed.",
                                    "constraints": {
                                        "required": true,
                                        "allowedValues": "[if(equals(steps('sessionHosts').sessionHostsRegionSection.sessionHostsAvailabilitySettings, false), map(first(map(filter(steps('sessionHosts').sessionHostsRegionSection.computeApi.value, (resourceTypes) => equals(resourceTypes.resourceType, 'virtualMachines')), (item) => item.locations)), (item) => parse(concat('{\"label\":\"', item, '\",\"value\":\"', toLower(replace(item, ' ', '')), '\"}'))), map(filter(first(map(filter(steps('sessionHosts').sessionHostsRegionSection.computeApi.value, (resourceTypes) => equals(resourceTypes.resourceType, 'virtualMachines')), (item) => item.zoneMappings)), (item) => equals(length(item.zones), 3)), (item) => parse(concat('{\"label\":\"', item.location, '\",\"value\":\"', toLower(replace(item.location, ' ', '')), '\"}'))))]"
                                    }
                                }
                            ]
                        },
                        {
                            "name": "sessionHostsComputeStorageSection",
                            "type": "Microsoft.Common.Section",
                            "visible": "[steps('sessionHosts').deploySessionHosts]",
                            "label": "General settings",
                            "tooltip": "This settings apply to compute, storage, image management and key vault resources.",
                            "elements": [
                                {
                                    "name": "identityDomainOuPath",
                                    "type": "Microsoft.Common.TextBox",
                                    "visible": "[not(equals(steps('identity').identityDomainInformation.identityServiceProvider, 'AAD'))]",
                                    "label": "Custom OU path (Optional)",
                                    "toolTip": "Provide OU where to locate session hosts, if not provided session hosts will be placed on the default (computers) OU.",
                                    "placeholder": "Example: OU=session-hosts,OU=avd,DC=contoso,DC=com",
                                    "constraints": {}
                                }
                            ]
                        },
                        {
                            "name": "sessionHostsSettingsSection",
                            "type": "Microsoft.Common.Section",
                            "visible": "[steps('sessionHosts').deploySessionHosts]",
                            "label": "Session hosts settings",
                            "elements": [
                                {
                                    "name": "sessionHostSize",
                                    "type": "Microsoft.Compute.SizeSelector",
                                    "label": "VM Size",
                                    "toolTip": "",
                                    "recommendedSizes": [
                                        "Standard_D4ads_v5"
                                    ],
                                    "constraints": {
                                        "allowedSizes": [],
                                        "excludedSizes": [],
                                        "required": true
                                    },
                                    "options": {
                                        "hideDiskTypeFilter": true
                                    },
                                    "osPlatform": "Windows",
                                    "imageReference": {
                                        "publisher": "MicrosoftWindowsDesktop",
                                        "offer": "Windows-11",
                                        "sku": "21h2-avd"
                                    }
                                },
                                {
                                    "name": "sessionHostSizeInfobox",
                                    "type": "Microsoft.Common.InfoBox",
                                    "visible": "[steps('sessionHosts').deploySessionHosts]",
                                    "options": {
                                        "text": "Session host virtual machine sizing guidelines.",
                                        "uri": "https://learn.microsoft.com/windows-server/remote/remote-desktop-services/virtual-machine-recs",
                                        "style": "Info"
                                    }
                                },
                                {
                                    "name": "sessionHostsCountIndex",
                                    "type": "Microsoft.Common.TextBox",
                                    "label": "VM count index",
                                    "toolTip": "Provide the number of the highest sessio host name count, example: if highest session host count is vmavd1duse20005, provide a count index of 5. This number will be use to deploy new session hosts with a naming that continues the current session hosts deployed, example: vmavd1duse20006.",
                                    "defaultValue": 1,
                                    "constraints": {
                                        "required": true
                                    }
                                },
                                {
                                    "name": "sessionHostsCount",
                                    "type": "Microsoft.Common.TextBox",
                                    "label": "VM count",
                                    "toolTip": "Provide the number of session hosts to deploy (1-100).",
                                    "defaultValue": 1,
                                    "constraints": {
                                        "required": true,
                                        "regex": "^([1-9]|[1-9][0-9]|[1][0][0])$",
                                        "validationMessage": "The count must be between 1-100 session hosts."
                                    }
                                },
                                {
                                    "name": "sessionHostDiskType",
                                    "type": "Microsoft.Common.DropDown",
                                    "label": "OS Disk type",
                                    "filter": true,
                                    "defaultValue": "Premium",
                                    "toolTip": "Select session host disk type to host the OS.",
                                    "constraints": {
                                        "required": true,
                                        "allowedValues": [
                                            {
                                                "label": "Standard",
                                                "value": "Standard_LRS"
                                            },
                                            {
                                                "label": "Premium",
                                                "value": "Premium_LRS"
                                            }
                                        ]
                                    }
                                },
                                {
                                    "name": "sessionHostDiskZeroTrust",
                                    "type": "Microsoft.Common.CheckBox",
                                    "label": "Zero trust disk configuration",
                                    "defaultValue": false,
                                    "toolTip": "Enables disk encryption and Zero trust settings on management VM and session hosts disks"
                                },
                                {
                                    "name": "ssessionHostDiskZeroTrustWarning",
                                    "type": "Microsoft.Common.InfoBox",
                                    "visible": "[steps('sessionHosts').sessionHostsSettingsSection.sessionHostDiskZeroTrust]",
                                    "options": {
                                        "text": "Zero trust disk encryption requires feature EncryptionAtHost of resource provider Microsoft.Compute to be registered in the subscription.",
                                        "uri": "https://learn.microsoft.com/azure/virtual-machines/disks-enable-host-based-encryption-portal?tabs=azure-powershell",
                                        "style": "Warning"
                                    }
                                },
                                {
                                    "name": "acceleratedNetworking",
                                    "type": "Microsoft.Common.CheckBox",
                                    "label": "Enable accelerated networking",
                                    "defaultValue": true,
                                    "toolTip": "Enables low latency and high throughput on the network interface."
                                },
                                {
                                    "name": "warningAcceleratedNetworkingSupport",
                                    "type": "Microsoft.Common.InfoBox",
                                    "visible": "[steps('sessionHosts').sessionHostsOsSection.sessionHostsImageSource]",
                                    "options": {
                                        "text": "The Compute Gallery Image definition selected must have the 'isAcceleratedNetworkSupported' feature property set to 'true' if you enable accelerated networking on the session hosts.",
                                        "uri": "https://github.com/Azure/avdaccelerator/blob/main/workload/docs/getting-started-baseline.md",
                                        "style": "Warning"
                                    }
                                }
                            ]
                        },
                        {
                            "name": "sessionHostsOsSection",
                            "type": "Microsoft.Common.Section",
                            "visible": "[steps('sessionHosts').deploySessionHosts]",
                            "label": "OS selection",
                            "elements": [
                                {
                                    "name": "sessionHostsImageSource",
                                    "type": "Microsoft.Common.DropDown",
                                    "label": "OS image source",
                                    "filter": true,
                                    "defaultValue": "Marketplace",
                                    "toolTip": "Select marketplace or build custom image to deploy the session hosts.",
                                    "constraints": {
                                        "required": true,
                                        "allowedValues": [
                                            {
                                                "label": "Marketplace",
                                                "value": false
                                            },
                                            {
                                                "label": "Compute Gallery",
                                                "value": true
                                            }
                                        ]
                                    }
                                },
                                {
                                    "name": "sessionHostsOsImage",
                                    "type": "Microsoft.Common.DropDown",
                                    "visible": "[not(steps('sessionHosts').sessionHostsOsSection.sessionHostsImageSource)]",
                                    "label": "OS version",
                                    "filter": true,
                                    "defaultValue": "Windows 11 22H2 (Gen2)",
                                    "toolTip": "Select the operating system version of the session hosts.",
                                    "constraints": {
                                        "required": true,
                                        "allowedValues": [
                                            {
                                                "label": "Windows 10 21H2",
                                                "value": "win10_21h2"
                                            },
                                            {
                                                "label": "Windows 10 21H2 - Office 365",
                                                "value": "win10_21h2_office"
                                            },
                                            {
                                                "label": "Windows 10 22H2 (Gen2)",
                                                "value": "win10_22h2_g2"
                                            },
                                            {
                                                "label": "Windows 10 22H2 - Office 365 (Gen2)",
                                                "value": "win10_22h2_office_g2"
                                            },
                                            {
                                                "label": "Windows 11",
                                                "value": "win11_21h2"
                                            },
                                            {
                                                "label": "Windows 11 - Office 365",
                                                "value": "win11_21h2_office"
                                            },
                                            {
                                                "label": "Windows 11 22H2 (Gen2)",
                                                "value": "win11_22h2"
                                            },
                                            {
                                                "label": "Windows 11 22H2 - Office 365 (Gen2)",
                                                "value": "win11_22h2_office"
                                            }
                                        ]
                                    }
                                },
                                {
                                    "name": "sessionHostsComputeGalleryImage",
                                    "type": "Microsoft.Solutions.ResourceSelector",
                                    "visible": "[steps('sessionHosts').sessionHostsOsSection.sessionHostsImageSource]",
                                    "label": "Image",
                                    "resourceType": "Microsoft.Compute/galleries/images",
                                    "constraints": {
                                        "required": true
                                    }
                                }
                            ]
                        },
                        {
                            "name": "sessionHostsSecuritySection",
                            "type": "Microsoft.Common.Section",
                            "visible": "[and(equals(steps('sessionHosts').deploySessionHosts, true), or(contains(steps('sessionHosts').sessionHostsOsSection.sessionHostsOsImage, 'win11'), contains(steps('sessionHosts').sessionHostsOsSection.sessionHostsOsImage, 'g2'), not(empty(steps('sessionHosts').sessionHostsOsSection.sessionHostsComputeGalleryImage))))]",
                            "label": "Security profile",
                            "elements": [
                                {
                                    "name": "sessionHostSecurityTypeWarning",
                                    "type": "Microsoft.Common.InfoBox",
                                    "visible": "[not(empty(steps('sessionHosts').sessionHostsOsSection.sessionHostsComputeGalleryImage))]",
                                    "options": {
                                        "text": "Setting the Security Type to anything other than 'Standard' requires that the Azure Compute Gallery Image Definition be configured with the Security Type feature set to the appropriate value. You can determine if the image definition supports the required feature by reviewing the 'Properties' tab on the 'Overview' node of the Gallery Image Definition in the portal. If the image definition does not contain these feature options, then the deployment will fail.",
                                        "uri": "https://learn.microsoft.com/azure/templates/microsoft.compute/galleries/images?pivots=deployment-language-bicep",
                                        "style": "Warning"
                                    }
                                },
                                {
                                    "name": "securityType",
                                    "type": "Microsoft.Common.DropDown",
                                    "label": "Security type",
                                    "filter": true,
                                    "defaultValue": "Trusted Launch Virtual Machines",
                                    "toolTip": "Choose a type of security that matches your needs: Standard includes basic protections at no additional cost. Trusted launch virtual machines provide additional security features on Gen2 virtual machines to protect against persistent and advanced attacks.",
                                    "constraints": {
                                        "required": true,
                                        "allowedValues": [
                                            {
                                                "label": "Standard",
                                                "value": "Standard"
                                            },
                                            {
                                                "label": "Trusted Launch Virtual Machines",
                                                "value": "TrustedLaunch"
                                            },
                                            {
                                                "label": "Confidential Virtual Machines",
                                                "value": "ConfidentialVM"
                                            }
                                        ]
                                    }
                                },
                                {
                                    "name": "secureBootEnabled",
                                    "type": "Microsoft.Common.CheckBox",
                                    "visible": "[or(equals(steps('sessionHosts').sessionHostsSecuritySection.securityType, 'TrustedLaunch'), equals(steps('sessionHosts').sessionHostsSecuritySection.securityType, 'ConfidentialVM'))]",
                                    "label": "Enable secure boot",
                                    "defaultValue": true,
                                    "toolTip": "Secure boot helps protect your VMs against boot kits, rootkits, and kernel-level malware."
                                },
                                {
                                    "name": "vTpmEnabled",
                                    "type": "Microsoft.Common.CheckBox",
                                    "visible": "[or(equals(steps('sessionHosts').sessionHostsSecuritySection.securityType, 'TrustedLaunch'), equals(steps('sessionHosts').sessionHostsSecuritySection.securityType, 'ConfidentialVM'))]",
                                    "label": "Enable vTPM",
                                    "defaultValue": true,
                                    "toolTip": "Virtual Trusted Platform Module (vTPM) is TPM2.0 compliant and validates your VM boot integrity apart from securely storing keys and secrets."
                                }
                            ]
                        }
                    ]
                },
                {
                    "name": "storage",
                    "label": "Storage",
                    "elements": [
                        {
                            "name": "fslogixConfiguration",
                            "type": "Microsoft.Common.CheckBox",
                            "label": "Configure FSLogix",
                            "defaultValue": false,
                            "toolTip": "Configure session host to use FSLogix."
                        },
                        {
                            "name": "storageFslogix",
                            "type": "Microsoft.Common.Section",
                            "label": "Settings:",
                            "visible": "[steps('storage').fslogixConfiguration]",
                            "elements": [
                                {
                                    "name": "identityDomainName",
                                    "type": "Microsoft.Common.TextBox",
                                    "label": "AD Domain name",
                                    "visible": "[equals(steps('identity').identityDomainInformation.identityServiceProvider, 'AAD')]",
                                    "toolTip": "The full qualified domain name of the on-premises domain where the hybrid identities originated from, this information is used for Azure files authentication setup.",
                                    "placeholder": "Example: contoso.com",
                                    "constraints": {
                                        "required": true
                                    }
                                },
                                {
                                    "name": "fslogixStorageAccountSelector",
                                    "type": "Microsoft.Solutions.ResourceSelector",
                                    "label": "Storage account",
                                    "toolTip": "Select storage account created and configured to host FSLogix user profile containers.",
                                    "resourceType": "Microsoft.Storage/storageAccounts",
                                    "constraints": {
                                        "required": true
                                    },
                                    "options": {
                                        "filter": {
                                            "subscription": "onBasics",
                                            "location": "[steps('SessionHosts').SessionHostsRegionSection.SessionHostsRegion.location.name]"
                                        }
                                    }
                                },
                                {
                                    "name": "fslogixStorageAccountFileShare",
                                    "type": "Microsoft.Common.TextBox",
                                    "label": "File share name",
                                    "toolTip": "The name of the file share created and configured to host FSLogix user profile containers.",
                                    "placeholder": "Example: fslogix-pc-avd1-dev-use2-001",
                                    "constraints": {
                                        "required": true,
                                        "subscription":"onBasics",
                                        "location":"[steps('SessionHosts').SessionHostsRegionSection.SessionHostsRegion.location.name]"
                                    }
                                }
                            ]
                        },
                        {
                            "name": "StorageConfigurationRequirements1",
                            "type": "Microsoft.Common.InfoBox",
                            "visible": "[and(steps('storage').fslogixConfiguration, not(equals(steps('identity').identityDomainInformation.identityServiceProvider, 'AAD')))]",
                            "options": {
                                "text": "FSLogix configuration requires the storage account and file share to be already configured for authentication with ADDS or Microsoft Entra Domain Services.",
                                "uri": "https://learn.microsoft.com/azure/virtual-desktop/fslogix-profile-container-configure-azure-files-active-directory?tabs=adds",
                                "style": "Info"
                            }
                        },
                        {
                            "name": "StorageConfigurationRequirements2",
                            "type": "Microsoft.Common.InfoBox",
                            "visible": "[and(steps('storage').fslogixConfiguration, equals(steps('identity').identityDomainInformation.identityServiceProvider, 'AAD'))]",
                            "options": {
                                "text": "FSLogix configuration requires the storage account and file share to be already configured for authentication with Microsoft Entra ID.",
                                "uri": "https://learn.microsoft.com/azure/virtual-desktop/create-profile-container-azure-ad",
                                "style": "Info"
                            }
                        },
                        {
                            "name": "StorageConfigurationAad",
                            "type": "Microsoft.Common.InfoBox",
                            "visible": "[and(steps('storage').fslogixConfiguration, equals(steps('identity').identityDomainInformation.identityServiceProvider, 'AAD'))]",
                            "options": {
                                "text": "FSLogix storage for Microsoft Entra ID joined session hosts is currently only available for hybrid identities.",
                                "uri": "https://learn.microsoft.com/azure/virtual-desktop/create-profile-container-azure-ad",
                                "style": "Info"
                            }
                        }
                    ]
                },
                {
                    "name": "network",
                    "label": "Networking",
                    "type": "Microsoft.Common.Section",
                    "visible": true,
                    "elements": [
                        {
                            "name": "networkSettings",
                            "type": "Microsoft.Common.Section",
                            "label": "Settings:",
                            "visible": true,
                            "elements": [
                                {
                                    "name": "virtualNetworkSelectorId",
                                    "type": "Microsoft.Solutions.ResourceSelector",
                                    "label": "Virtual network",
                                    "resourceType": "Microsoft.Network/virtualNetworks",
                                    "constraints": {
                                        "required": true
                                    },
                                    "options": {
                                        "filter": {
                                            "subscription": "onBasics",
                                            "location": "[steps('SessionHosts').SessionHostsRegionSection.SessionHostsRegion.location.name]"
                                        }
                                    }
                                },
                                {
                                    "name": "subnetApi",
                                    "type": "Microsoft.Solutions.ArmApiControl",
                                    "request": {
                                        "method": "GET",
                                        "path": "[concat(steps('network').networkSettings.virtualNetworkSelectorId.id, '/subnets?api-version=2021-03-01')]"
                                    }
                                },
                                {
                                    "name": "virtualNetworkSubnetSelectorName",
                                    "label": "Subnet",
                                    "type": "Microsoft.Common.DropDown",
                                    "defaultValue": "",
                                    "toolTip": "Azure Virtual Desktop subnet.",
                                    "multiselect": false,
                                    "selectAll": false,
                                    "filter": true,
                                    "filterPlaceholder": "Filter items ...",
                                    "multiLine": true,
                                    "constraints": {
                                        "allowedValues": "[map(steps('network').networkSettings.subnetApi.value,(item) => parse(concat('{\"label\":\"', item.name, '\",\"value\":\"', item.id, '\",\"description\":\"', 'Resource Group: ', last(take(split(item.id, '/'), 5)), '\"}')))]",
                                        "required": true
                                    }
                                },
                                {
                                    "name": "applicationSecurityGroup",
                                    "type": "Microsoft.Common.CheckBox",
                                    "label": "Application Security Group (ASG)",
                                    "defaultValue": true,
                                    "toolTip": "Configure session host to use FSLogix."
                                },
                                {
                                    "name": "applicationSecurityGroupSelectorId",
                                    "type": "Microsoft.Solutions.ResourceSelector",
                                    "visible": "[steps('network').networkSettings.applicationSecurityGroup]",
                                    "label": "Select ASG",
                                    "resourceType": "Microsoft.Network/applicationSecurityGroups",
                                    "options": {
                                        "filter": {
                                            "subscription": "onBasics",
                                            "location": "[steps('SessionHosts').SessionHostsRegionSection.SessionHostsRegion.location.name]"
                                        }
                                    }
                                }
                            ]
                        }
                    ]
                },
                {
                    "name": "monitoring",
                    "label": "Monitoring",
                    "type": "Microsoft.Common.Section",
                    "visible": true,
                    "elements": [
                        {
                            "name": "configureMonitoring",
                            "type": "Microsoft.Common.CheckBox",
                            "visible": true,
                            "label": "Configure monitoring",
                            "defaultValue": false,
                            "toolTip": "Deploy monitoring settings and if selected deploy Azure log analytics workspace."
                        },
                        {
                            "name": "motoringSettings",
                            "type": "Microsoft.Common.Section",
                            "label": "Settings:",
                            "visible": "[steps('monitoring').configureMonitoring]",
                            "elements": [
                                {
                                    "name": "monitoringWorkspaceSelection",
                                    "type": "Microsoft.Solutions.ResourceSelector",
                                    "label": "Log analytics workspace",
                                    "resourceType": "Microsoft.OperationalInsights/workspaces",
                                    "constraints": {
                                        "required": true
                                    }
                                },
                                {
                                    "name": "deployMonitoringInfo1",
                                    "type": "Microsoft.Common.InfoBox",
                                    "options": {
                                        "text": "Azure Virtual Desktop monitoring requires an existing Azure Log Analytics Workspace or the creation of a new one.",
                                        "uri": "https://docs.microsoft.com/azure/virtual-desktop/azure-monitor",
                                        "style": "Info"
                                    }
                                },
                                {
                                    "name": "deployMonitoringInfo2",
                                    "type": "Microsoft.Common.InfoBox",
                                    "options": {
                                        "text": "Deployment will configured all required settings to use the Azure Virtual Desktop insights workbook.",
                                        "uri": "https://learn.microsoft.com/azure/virtual-desktop/azure-monitor?WT.mc_id=Portal-AppInsightsExtension",
                                        "style": "Info"
                                    }
                                }
                            ]
                        }
                    ]
                },
                {
                    "name": "resourceNaming",
                    "label": "Resource naming",
                    "type": "Microsoft.Common.Section",
                    "visible": true,
                    "elements": [
                        {
                            "name": "resourceNamingInfo1",
                            "type": "Microsoft.Common.InfoBox",
                            "visible": true,
                            "options": {
                                "text": "Azure Virtual Desktop LZA default naming scheme is shown in this diagram.",
                                "uri": "https://github.com/Azure/avdaccelerator/blob/main/workload/docs/diagrams/avd-accelerator-resource-organization-naming.png",
                                "style": "Info"
                            }
                        },
                        {
                            "name": "resourceNamingSelection",
                            "type": "Microsoft.Common.CheckBox",
                            "visible": true,
                            "label": "Custom resource naming",
                            "defaultValue": false,
                            "toolTip": "When selected, the information provided will be used to name resources. When set to 'No' deployment will use the Azure Virtual Desktop LZA naming standard."
                        },
                        {
                            "name": "resourceNamingWarning",
                            "type": "Microsoft.Common.InfoBox",
                            "visible": "[steps('resourceNaming').resourceNamingSelection]",
                            "options": {
                                "text": "When using custom naming for resources, please make sure to follow naming rules and restrictions for Azure resources.",
                                "uri": "https://docs.microsoft.com/azure/azure-resource-manager/management/resource-name-rules",
                                "style": "Warning"
                            }
                        },
                        {
                            "name": "resourceNamingCompute",
                            "type": "Microsoft.Common.Section",
                            "label": "Compute naming:",
                            "visible": "[steps('resourceNaming').resourceNamingSelection]",
                            "elements": [
                                {
                                    "name": "sessionHostCustomNamePrefix",
                                    "type": "Microsoft.Common.TextBox",
                                    "label": "Session host prefix",
                                    "visible": "[steps('sessionHosts').deploySessionHosts]",
                                    "toolTip": "Azure Virtual Desktop session host prefix custom name.",
                                    "placeholder": "Example: vmapp1deus2",
                                    "constraints": {
                                        "required": true,
                                        "regex": "^[a-z0-9A-Z-]{1,11}$",
                                        "validationMessage": "Value must be 1-11 characters."
                                    }
                                }
                            ]
                        },
                        {
                            "name": "resourceNamingInfo2",
                            "type": "Microsoft.Common.InfoBox",
                            "visible": "[steps('resourceNaming').resourceNamingSelection]",
                            "options": {
                                "text": "It is recommended to follow Microsoft Cloud Adoption Framework (CAF) naming convention.",
                                "uri": "https://docs.microsoft.com/azure/cloud-adoption-framework/ready/azure-best-practices/resource-naming",
                                "style": "Info"
                            }
                        }
                    ]
                },
                {
                    "name": "resourceTagging",
                    "label": "Resource tagging",
                    "type": "Microsoft.Common.Section",
                    "visible": true,
                    "elements": [
                        {
                            "name": "resourceTaggingSelection",
                            "type": "Microsoft.Common.CheckBox",
                            "visible": true,
                            "label": "Create resource tags",
                            "defaultValue": false,
                            "toolTip": "When selected, the information provided will be used to create tags on resources and resource groups."
                        },
                        {
                            "name": "resourceTaggingParentCostInfo",
                            "type": "Microsoft.Common.InfoBox",
                            "options": {
                                "text": "By default, the following tags will be created: <br/> - Parent resource cost management tag (cm-resource-parent): reports all resources cost to the host pool (ResourceID). <br/> - Environment (Environment): environment selected during deployment (Dev/Test/prod). <br/> - Service Workload (ServiceWorkload): defaults to Azure Virtual Desktop. <br/> - Creation time (CreationTimeUTC): deployment time in UTC. <br/> - Domain Name (DomainName): identity service domain name (applied only to compute and storage). <br/> - Identity service provider (IdentityServiceProvider): identity provider selected (ADDS/AADDS/AAD).",
                                "uri": "https://learn.microsoft.com/azure/virtual-desktop/tag-virtual-desktop-resources#use-the-cm-resource-parent-tag-to-automatically-group-costs-by-host-pool",
                                "style": "Info"
                            }
                        },
                        {
                            "name": "resourceTags",
                            "type": "Microsoft.Common.Section",
                            "label": "Resources tags:",
                            "visible": "[steps('resourceTagging').resourceTaggingSelection]",
                            "elements": [
                                {
                                    "name": "tagsWorkloadName",
                                    "type": "Microsoft.Common.TextBox",
                                    "label": "Workload name:",
                                    "toolTip": "This input will be the value of a tag named WorkloadName.",
                                    "placeholder": "Example: Contoso-Workload",
                                    "constraints": {
                                        "required": true,
                                        "regex": "^[a-z0-9A-Z-]{1,256}$",
                                        "validationMessage": "Value must be 1-256 characters."
                                    }
                                },
                                {
                                    "name": "tagsWorkloadType",
                                    "type": "Microsoft.Common.DropDown",
                                    "label": "Workload type:",
                                    "filter": true,
                                    "defaultValue": "Light",
                                    "toolTip": "This input will be the value of a tag named WorkloadType, reference to the size of the VM for your workloads.",
                                    "constraints": {
                                        "required": true,
                                        "allowedValues": [
                                            {
                                                "label": "Light",
                                                "description": "",
                                                "value": "Light"
                                            },
                                            {
                                                "label": "Medium",
                                                "description": "",
                                                "value": "Medium"
                                            },
                                            {
                                                "label": "High",
                                                "description": "",
                                                "value": "High"
                                            },
                                            {
                                                "label": "Power",
                                                "description": "",
                                                "value": "POwer"
                                            }
                                        ]
                                    }
                                },
                                {
                                    "name": "tagsDataClassificationTag",
                                    "type": "Microsoft.Common.DropDown",
                                    "label": "Data classification:",
                                    "filter": true,
                                    "defaultValue": "Non-business",
                                    "toolTip": "This input will be the value of a tag named DataClassification, reference to the sensitivity of data hosted.",
                                    "constraints": {
                                        "required": true,
                                        "allowedValues": [
                                            {
                                                "label": "Non-business",
                                                "description": "",
                                                "value": "Non-business"
                                            },
                                            {
                                                "label": "Public",
                                                "description": "",
                                                "value": "Public"
                                            },
                                            {
                                                "label": "General",
                                                "description": "",
                                                "value": "General"
                                            },
                                            {
                                                "label": "Confidential",
                                                "description": "",
                                                "value": "Confidential"
                                            },
                                            {
                                                "label": "Highly-confidential",
                                                "description": "",
                                                "value": "Highly-confidential"
                                            }
                                        ]
                                    }
                                },
                                {
                                    "name": "tagsDepartmentTag",
                                    "type": "Microsoft.Common.TextBox",
                                    "label": "Department:",
                                    "toolTip": "This input will be the value of a tag named Department, reference the department that owns the deployment.",
                                    "placeholder": "Example: Contoso-AVD",
                                    "constraints": {
                                        "required": true,
                                        "regex": "^[a-z0-9A-Z-]{1,256}$",
                                        "validationMessage": "Value must be 1-256 characters."
                                    }
                                },
                                {
                                    "name": "tagsCriticalityTag",
                                    "type": "Microsoft.Common.DropDown",
                                    "label": "Workload criticality:",
                                    "filter": true,
                                    "defaultValue": "Low",
                                    "toolTip": "This input will be the value of a tag named Criticality, reference to the criticality of the workload.",
                                    "constraints": {
                                        "required": true,
                                        "allowedValues": [
                                            {
                                                "label": "Low",
                                                "description": "",
                                                "value": "Low"
                                            },
                                            {
                                                "label": "Medium",
                                                "description": "",
                                                "value": "Medium"
                                            },
                                            {
                                                "label": "High",
                                                "description": "",
                                                "value": "High"
                                            },
                                            {
                                                "label": "Missin-critical",
                                                "description": "",
                                                "value": "Missin-critical"
                                            },
                                            {
                                                "label": "Custom",
                                                "description": "",
                                                "value": "Custom"
                                            }
                                        ]
                                    }
                                },
                                {
                                    "name": "tagsCustomWorkloadCriticality",
                                    "type": "Microsoft.Common.TextBox",
                                    "label": "Custom workload criticality:",
                                    "visible": "[equals(steps('resourceTagging').resourceTags.tagsCriticalityTag, 'Custom')]",
                                    "toolTip": "This input will be the value of a tag named Criticality, reference to a custom criticality for the workload.",
                                    "placeholder": "Example: Contoso-Criticality",
                                    "constraints": {
                                        "required": true,
                                        "regex": "^[a-z0-9A-Z-]{1,256}$",
                                        "validationMessage": "Value must be 1-256 characters."
                                    }
                                },
                                {
                                    "name": "tagsApplicationNameTag",
                                    "type": "Microsoft.Common.TextBox",
                                    "label": "Application name:",
                                    "toolTip": "This input will be the value of a tag named ApplicationName, reference details about the application.",
                                    "placeholder": "Example: Contoso-App",
                                    "constraints": {
                                        "required": true,
                                        "regex": "^[a-z0-9A-Z-]{1,256}$",
                                        "validationMessage": "Value must be 1-256 characters."
                                    }
                                },
                                {
                                    "name": "tagsWorkloadSlaTag",
                                    "type": "Microsoft.Common.TextBox",
                                    "label": "Workload SLA:",
                                    "toolTip": "This input will be the value of a tag named ServiceClass, reference to the service level agreement level of the worload.",
                                    "placeholder": "Example: Contoso-SLA",
                                    "constraints": {
                                        "required": true,
                                        "regex": "^[a-z0-9A-Z-]{1,256}$",
                                        "validationMessage": "Value must be 1-256 characters."
                                    }
                                },
                                {
                                    "name": "tagsOpsTeamTag",
                                    "type": "Microsoft.Common.TextBox",
                                    "label": "Operations team:",
                                    "toolTip": "This input will be the value of a tag named OpsTeam, reference to the team accountable for day-to-day operations.",
                                    "placeholder": "Example: workload-admins@Contoso.com",
                                    "constraints": {
                                        "required": true
                                    }
                                },
                                {
                                    "name": "tagsOwnerTag",
                                    "type": "Microsoft.Common.TextBox",
                                    "label": "Owner:",
                                    "toolTip": "This input will be the value of a tag named Owner, reference to the organizational owner of the Azure Virtual Desktop deployment.",
                                    "placeholder": "Example: workload-owner@Contoso.com",
                                    "constraints": {
                                        "required": true
                                    }
                                },
                                {
                                    "name": "tagsCostCenterTag",
                                    "type": "Microsoft.Common.TextBox",
                                    "label": "Cost center:",
                                    "toolTip": "This input will be the value of a tag named CostCenter, reference to the cost center of owner team.",
                                    "placeholder": "Example: Contoso-CC",
                                    "constraints": {
                                        "required": true,
                                        "regex": "^[a-z0-9A-Z-]{1,256}$",
                                        "validationMessage": "Value must be 1-256 characters."
                                    }
                                }
                            ]
                        }
                    ]
                }
            ]
        },
        "outputs": {
            "parameters": {},
            "kind": "resourceGroups",
            "location": "[steps('basics').resourceScope.location.name]",
            "subscriptionId": "[steps('basics').resourceScope.subscription.id]"
        }
    }
}
