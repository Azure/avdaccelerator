{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://azure.github.io/avdaccelerator/schemas/v1/avd-deployment.schema.json",
  "title": "AVD Deployment Specification",
  "description": "Schema for declarative Azure Virtual Desktop deployment specifications",
  "type": "object",
  "required": ["apiVersion", "kind", "metadata", "spec"],
  "properties": {
    "apiVersion": {
      "type": "string",
      "enum": ["avd.azure.com/v1"],
      "description": "API version of the specification"
    },
    "kind": {
      "type": "string",
      "enum": ["AVDDeployment"],
      "description": "Type of specification"
    },
    "metadata": {
      "type": "object",
      "required": ["name", "environment"],
      "properties": {
        "name": {
          "type": "string",
          "pattern": "^[a-z0-9-]+$",
          "minLength": 2,
          "maxLength": 50,
          "description": "Unique name for this deployment"
        },
        "environment": {
          "type": "string",
          "enum": ["dev", "test", "staging", "production"],
          "description": "Environment type"
        },
        "region": {
          "type": "string",
          "description": "Primary Azure region for deployment"
        },
        "description": {
          "type": "string",
          "description": "Human-readable description of the deployment"
        }
      }
    },
    "spec": {
      "type": "object",
      "required": ["identity", "hostPools", "networking"],
      "properties": {
        "deploymentPrefix": {
          "type": "string",
          "minLength": 2,
          "maxLength": 4,
          "description": "Prefix for resource naming (2-4 characters)"
        },
        "subscriptionId": {
          "type": "string",
          "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$",
          "description": "Azure subscription ID for deployment"
        },
        "identity": {
          "type": "object",
          "required": ["provider"],
          "properties": {
            "provider": {
              "type": "string",
              "enum": ["ADDS", "EntraDS", "EntraID", "EntraIDKerberos"],
              "description": "Identity service provider for AVD"
            },
            "domainName": {
              "type": "string",
              "description": "FQDN of the domain (required for ADDS/EntraDS)"
            },
            "domainGuid": {
              "type": "string",
              "description": "GUID of the domain"
            },
            "ouPath": {
              "type": "string",
              "description": "Organizational Unit path for computer objects"
            },
            "domainJoinCredentials": {
              "type": "object",
              "properties": {
                "username": {
                  "type": "string",
                  "description": "Domain join account username"
                },
                "passwordKeyVaultSecret": {
                  "type": "string",
                  "description": "Key Vault secret name containing password"
                }
              }
            },
            "intuneEnrollment": {
              "type": "boolean",
              "default": false,
              "description": "Enable Intune enrollment for session hosts"
            }
          }
        },
        "hostPools": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "object",
            "required": ["name", "type", "location", "sessionHosts"],
            "properties": {
              "name": {
                "type": "string",
                "description": "Host pool name"
              },
              "type": {
                "type": "string",
                "enum": ["Pooled", "Personal"],
                "description": "Host pool type"
              },
              "location": {
                "type": "string",
                "description": "Azure region for the host pool"
              },
              "preferredAppGroupType": {
                "type": "string",
                "enum": ["Desktop", "RemoteApp"],
                "default": "Desktop"
              },
              "publicNetworkAccess": {
                "type": "string",
                "enum": ["Disabled", "Enabled", "EnabledForClientsOnly", "EnabledForSessionHostsOnly"],
                "default": "Enabled"
              },
              "maxSessionLimit": {
                "type": "integer",
                "minimum": 1,
                "maximum": 999999,
                "description": "Maximum sessions per host (Pooled only)"
              },
              "loadBalancerType": {
                "type": "string",
                "enum": ["BreadthFirst", "DepthFirst", "Persistent"],
                "default": "BreadthFirst"
              },
              "startVMOnConnect": {
                "type": "boolean",
                "default": false
              },
              "sessionHosts": {
                "type": "object",
                "required": ["count", "vmSize"],
                "properties": {
                  "count": {
                    "type": "integer",
                    "minimum": 1,
                    "description": "Number of session hosts"
                  },
                  "vmSize": {
                    "type": "string",
                    "description": "Azure VM size (e.g., Standard_D4s_v5)"
                  },
                  "availabilityZones": {
                    "type": "array",
                    "items": {
                      "type": "string",
                      "enum": ["1", "2", "3"]
                    }
                  },
                  "imageSource": {
                    "type": "string",
                    "enum": ["marketplace", "gallery", "custom"],
                    "default": "marketplace"
                  },
                  "marketplace": {
                    "type": "object",
                    "properties": {
                      "publisher": {
                        "type": "string"
                      },
                      "offer": {
                        "type": "string"
                      },
                      "sku": {
                        "type": "string"
                      },
                      "version": {
                        "type": "string",
                        "default": "latest"
                      }
                    }
                  },
                  "gallery": {
                    "type": "object",
                    "properties": {
                      "resourceId": {
                        "type": "string"
                      },
                      "imageName": {
                        "type": "string"
                      },
                      "imageVersion": {
                        "type": "string"
                      }
                    }
                  },
                  "diskType": {
                    "type": "string",
                    "enum": ["Standard_LRS", "StandardSSD_LRS", "Premium_LRS"],
                    "default": "Premium_LRS"
                  },
                  "diskSizeGB": {
                    "type": "integer",
                    "minimum": 128
                  },
                  "acceleratedNetworking": {
                    "type": "boolean",
                    "default": true
                  },
                  "localAdminCredentials": {
                    "type": "object",
                    "properties": {
                      "username": {
                        "type": "string"
                      },
                      "passwordKeyVaultSecret": {
                        "type": "string"
                      }
                    }
                  }
                }
              },
              "scaling": {
                "type": "object",
                "properties": {
                  "enabled": {
                    "type": "boolean",
                    "default": false
                  },
                  "schedules": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "properties": {
                        "name": {
                          "type": "string"
                        },
                        "days": {
                          "type": "array",
                          "items": {
                            "type": "string",
                            "enum": ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"]
                          }
                        },
                        "rampUpStartTime": {
                          "type": "string",
                          "pattern": "^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$"
                        },
                        "peakStartTime": {
                          "type": "string",
                          "pattern": "^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$"
                        },
                        "rampDownStartTime": {
                          "type": "string",
                          "pattern": "^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$"
                        },
                        "offPeakStartTime": {
                          "type": "string",
                          "pattern": "^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$"
                        }
                      }
                    }
                  }
                }
              },
              "applicationGroups": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "name": {
                      "type": "string"
                    },
                    "type": {
                      "type": "string",
                      "enum": ["Desktop", "RemoteApp"]
                    },
                    "applications": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "name": {
                            "type": "string"
                          },
                          "path": {
                            "type": "string"
                          },
                          "commandLineArguments": {
                            "type": "string"
                          }
                        }
                      }
                    },
                    "assignedUsers": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      }
                    }
                  }
                }
              }
            }
          }
        },
        "networking": {
          "type": "object",
          "required": ["createNew"],
          "properties": {
            "createNew": {
              "type": "boolean",
              "description": "Create new VNet or use existing"
            },
            "vnet": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string"
                },
                "resourceId": {
                  "type": "string",
                  "description": "Existing VNet resource ID (if createNew is false)"
                },
                "addressSpace": {
                  "type": "string",
                  "pattern": "^([0-9]{1,3}\\.){3}[0-9]{1,3}/[0-9]{1,2}$"
                },
                "subnets": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "name": {
                        "type": "string"
                      },
                      "addressPrefix": {
                        "type": "string"
                      },
                      "networkSecurityGroup": {
                        "type": "boolean",
                        "default": true
                      }
                    }
                  }
                },
                "dnsServers": {
                  "type": "array",
                  "items": {
                    "type": "string"
                  }
                }
              }
            },
            "hubVnet": {
              "type": "object",
              "properties": {
                "enabled": {
                  "type": "boolean",
                  "default": false
                },
                "resourceId": {
                  "type": "string"
                },
                "allowGatewayTransit": {
                  "type": "boolean",
                  "default": false
                }
              }
            }
          }
        },
        "storage": {
          "type": "object",
          "properties": {
            "fslogix": {
              "type": "object",
              "properties": {
                "enabled": {
                  "type": "boolean",
                  "default": true
                },
                "storageType": {
                  "type": "string",
                  "enum": ["AzureFiles", "AzureNetAppFiles"],
                  "default": "AzureFiles"
                },
                "azureFiles": {
                  "type": "object",
                  "properties": {
                    "sku": {
                      "type": "string",
                      "enum": ["Standard_LRS", "Standard_GRS", "Premium_LRS"],
                      "default": "Premium_LRS"
                    },
                    "quota": {
                      "type": "integer",
                      "minimum": 100,
                      "description": "Share quota in GB"
                    },
                    "privateEndpoint": {
                      "type": "boolean",
                      "default": true
                    }
                  }
                }
              }
            },
            "appAttach": {
              "type": "object",
              "properties": {
                "enabled": {
                  "type": "boolean",
                  "default": false
                },
                "storageType": {
                  "type": "string",
                  "enum": ["AzureFiles", "AzureNetAppFiles"],
                  "default": "AzureFiles"
                }
              }
            }
          }
        },
        "security": {
          "type": "object",
          "properties": {
            "encryption": {
              "type": "object",
              "properties": {
                "encryptionAtHost": {
                  "type": "boolean",
                  "default": false
                },
                "diskEncryptionKeyExpiration": {
                  "type": "integer",
                  "minimum": 30,
                  "maximum": 730,
                  "default": 60
                }
              }
            },
            "privateLink": {
              "type": "object",
              "properties": {
                "enabled": {
                  "type": "boolean",
                  "default": false
                },
                "dnsZones": {
                  "type": "array",
                  "items": {
                    "type": "string"
                  }
                }
              }
            },
            "confidentialVm": {
              "type": "boolean",
              "default": false
            },
            "trustedLaunch": {
              "type": "boolean",
              "default": true
            },
            "securityGroups": {
              "type": "array",
              "description": "Azure AD/Entra ID group object IDs for RBAC",
              "items": {
                "type": "string"
              }
            }
          }
        },
        "monitoring": {
          "type": "object",
          "properties": {
            "logAnalytics": {
              "type": "object",
              "properties": {
                "enabled": {
                  "type": "boolean",
                  "default": true
                },
                "retentionDays": {
                  "type": "integer",
                  "minimum": 30,
                  "maximum": 730,
                  "default": 90
                },
                "existingWorkspaceId": {
                  "type": "string"
                }
              }
            },
            "insights": {
              "type": "object",
              "properties": {
                "enabled": {
                  "type": "boolean",
                  "default": true
                }
              }
            },
            "alerts": {
              "type": "object",
              "properties": {
                "enabled": {
                  "type": "boolean",
                  "default": true
                },
                "actionGroupEmail": {
                  "type": "string",
                  "format": "email"
                }
              }
            }
          }
        },
        "policies": {
          "type": "object",
          "properties": {
            "gpu": {
              "type": "boolean",
              "default": false
            },
            "monitoring": {
              "type": "boolean",
              "default": true
            },
            "networking": {
              "type": "boolean",
              "default": true
            },
            "zeroTrust": {
              "type": "boolean",
              "default": false
            }
          }
        },
        "tags": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          },
          "description": "Azure resource tags"
        }
      }
    }
  }
}
